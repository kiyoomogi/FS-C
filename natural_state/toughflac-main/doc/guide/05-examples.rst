.. _examples:

Examples
========

Following subsections provide instructions to develop and run two example problems. The first example provides a step-by-step description of the standard development of a problem, from grid generation to output visualization. The second example is less detailed since the main steps are similar to the first problem, and is mainly included to demonstrate the use of advanced features to run a coupled TOUGH-FLAC simulation (e.g. import grid generated by Gmsh, export results to a VTK file...).


.. _example-1:

CO\ :sub:`2` injection in a reservoir-caprock system
----------------------------------------------------

This example describes a problem of injection of CO\ :sub:`2` into a reservoir overlaid by a caprock. The problem was first presented in :cite:`Rutqvist2002`. All the necessary input files can be found in a directory named *2dldV6*. This directory contains the coupling Python script *flac3d.py* and five subdirectories:

* *1_TH_INI* to run a steady state calculation with TOUGH3 only,
* *2_TH* to test input files required for TOUGH3,
* *3_THM* to conduct a fully coupled TOUGH3 and FLAC3D v6 simulation,
* *Preprocessing* that contains scripts to generate TOUGH3 and FLAC3D grids (*generate_mesh.py*) and configure the mechanical model for FLAC3D (*initialize_model.f3grid*),
* *Postprocessing* that contains a sample script to plot history variables.

The three former subdirectories contain the TOUGH3 input file, a file *CO2TAB* needed for equation-of-state ECO2N, and two Bash scripts *clean.sh* and *run.sh*. These two scripts are not necessary and are only here for convenience (facilitate the workflow).

The user might want to start and save a new FLAC3D project in this directory (i.e. *2dldV6*).


.. _ex1-grids-generation:

Grid generation for TOUGH3 and FLAC3D
*************************************

.. note::

    The pre-processing steps presented in this section are independent of the version of TOUGH-FLAC. This also means that FLAC3D can be used as a simple pre-processor to conduct a TOUGH simulation.

The first step is to generate a grid consistent for both TOUGH3 and FLAC3D. This step is usually the most time-consuming task from the user end and requires manual edit of TOUGH3 *MESH* file. :mod:`toughflac` provides several functions to facilitate and automate several manual labors.

The geometry of the problem is presented in Figure :numref:`%s <2dldV6-model>` and is extended far enough in the lateral direction to be infinite acting.

.. figure:: ../figures/2dldV6/model.*
    :name: 2dldV6-model
    :align: center
    :width: 50%

    Vertical profile of the finite difference model with rock units (:cite:`Rutqvist2002`). Note that the vertical fault is not modeled in this example.

The Python script *generate_mesh.py* is written to produce the grids for TOUGH3 and FLAC3D corresponding to this problem. The user can simply open and execute this script in FLAC3D to produce the desired grids. In the following, we will go through the content of this script line-by-line.

First, import both :mod:`itasca` and :mod:`toughflac` modules:

.. code-block:: python

    import itasca as it
    import toughflac as tf


.. _ex1-grid:

Generate grid
^^^^^^^^^^^^^

To generate the grid without any group, similarly to TOUGH3's MESHMAKER, we define the block sizes in X, Y and Z directions using a list (or anything array-like):

.. code-block:: python

    dx = [
        113255.0,   78894.0,    52596.0,    35064.0,    23376.0,    15584.0,    10389.0,    6926.0,
        # ...
        78894.0,    113255.0,
    ]
    dy = [1.0]
    dz = [
        0.1,    250.0,  250.0,  194.0,  180.0,  120.0,  80.0,   53.0,
        # ...
        100.0,  200.0,  400.0,  700.0,  0.1,
    ][::-1]

Since the problem is 2D, ``dy`` is set to ``[1.0]`` which means that we want a single 1-meter thick block in Y direction. ``dz`` is defined from top to bottom. FLAC3D creates grid from bottom to top in a right-handed coordinate system, thus the list ``dz`` should be reversed (by using ``[::-1]`` for instance).

We also have to define the origin point of the grid to facilitate later coordinate queries:

.. code-block:: python

    point_0 = [-350000.0, -0.5, -3000.1]

Now, we can call the function :func:`toughflac.zone.create.tartan_brick` provided by the module to create an irregular cartesian grid given the block sizes ``dx``, ``dy`` and ``dz`` and the origin point ``point_0``:

.. code-block:: python

    tf.zone.create.tartan_brick(dx, dy, dz, point_0=point_0)

So far, only the grid points and zones have been created, but no group has been associated to the zones yet (the grid should look like Figure :numref:`%s <2dldV6-model-no-group>`).

.. figure:: ../figures/2dldV6/model_no_group.*
    :name: 2dldV6-model-no-group
    :align: center
    :width: 75%

    FLAC3D grid once created without any group assigned (all zones are assigned to default group *Brick1*.


.. _ex1-assign-groups:

Assign groups
^^^^^^^^^^^^^

Groups can be easily assigned using the function :func:`toughflac.zone.group` that selects zones that are within a specific rectangular region:

.. code-block:: python

    tf.zone.group("ATMOS", range_z=(0.0, 1.0))
    tf.zone.group("UPPER", range_z=(-1200.0, 0.0))
    tf.zone.group("CAPRO", range_z=(-1300.0, -1200.0))
    tf.zone.group("AQFER", range_z=(-1500.0, -1300.0))
    tf.zone.group("BASEM", range_z=(-3000.0, -1500.0))
    tf.zone.group("BOTOM", range_z=(-3001.0, -3000.0))

The boundary groups ``ATMOS`` and ``BOTOM`` have been created to define the top and bottom boundary conditions, respectively. The grid should now look like Figure :numref:`%s <2dldV6-model-with-group>`.

.. figure:: ../figures/2dldV6/model_with_group.*
    :name: 2dldV6-model-with-group
    :align: center
    :width: 75%

    FLAC3D grid with all zone groups assigned. Group *Brick1* has disappeared from the left panel.


.. _ex1-define-incon-bc:

Define boundary and initial conditions
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Usually, time-independent Dirichlet boundary conditions are defined by manually setting the volume of boundary elements to a large value (e.g. 10\ :sup:`50`) and nodal distances to small value (e.g. 10\ :sup:`-9`) in TOUGH3 *MESH* file. This task can be automated by using the function :func:`toughflac.zone.set_dirichlet_bc` and specifying to which zone groups Dirichlet boundary conditions should be applied. Initial conditions can be defined by initializing primary variables as constant or following a gradient with respect to zone depth using the function :func:`toughflac.zone.initialize_pvariables`.

In this example, the pressure and temperature are set to atmospheric conditions (P = 0.1 MPa and T = 10 deg). The pressure (X1) is set to hydrostatic pressure and the temperature gradient (X4) is 25 deg/km. Salt and CO\ :sub:`2` mass fractions (X2 and X3) are set to 0.05 and 0, respectively.

.. code-block:: python

    tf.zone.set_dirichlet_bc("ATMOS")
    tf.zone.initialize_pvariables(
        x1=lambda z: 1.0e5 - 9810.0 * z,
        x2=lambda z: 0.05,
        x3=lambda z: 0.0,
        x4=lambda z: 10.0 - 0.025 * z,
    )

.. tip::

    Anonymous functions ``lambda`` are generally used to define temporary functions to be passed to another function.


.. _ex1-export-grid:

Export grids for TOUGH and FLAC3D
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Finally, TOUGH3 *MESH* and *INCON* files can be written using the function :func:`toughflac.zone.export_tough`:

.. code-block:: python

    tf.zone.export_tough("MESH", incon=True)

The *MESH* file produced using this function does not need to be manually edited: element materials and Dirichlet boundary conditions have already been applied.

FLAC3D grid can be exported using the function :func:`toughflac.zone.export_flac`:

.. code-block:: python

    tf.zone.export_flac("mesh.f3grid", binary=True)


.. _ex1-steady-state:

Calculation of steady state
***************************

It is common to run a steady state pre-injection calculation to obtain the correct reservoir temperature, pressure and stress fields at the start of the CO\ :sub:`2` injection.

We first run a TOUGH3 (only) simulation without injection to obtain the correct pressure and temperature conditions. Navigate to the folder *1_TH_INI* (see Figure :numref:`%s <2dldV6-ini>`).

.. figure:: ../figures/2dldV6/1_th_ini.*
    :name: 2dldV6-ini
    :align: center

    Contents of directory *1_TH_INI* before calculation of steady state.

To calculate the steady state, the subdirectory should contain the files:

* *2dldV6i.dat*: TOUGH3 input file without blocks ``FLAC`` and ``GENER``, the blocks ``ROCKS``, ``MULTI``, ``SELEC``, ``SOLVR`` and ``PARAM`` have already been filled in. The run is conducted during 300 time steps,

* *MESH* and *INCON*: previously created in FLAC3D in Section :ref:`ex1-grids-generation`,

* *CO2TAB*: required by equation-of-state ECO2N.

To start the simulation (without MPI), simply type in Cygwin:

.. code-block:: bash

    tough3-eco2n 2dldV6i.dat

This should produce a *SAVE* file that will be used as initial conditions for the subsequent runs.

.. tip::

    The user can execute the Bash script *run.sh* that will automatically import *MESH* and *INCON* before running the simulation:

    .. code-block:: bash

        ./run.sh

    The relative path to files *MESH* and *INCON* might need to be modified if the FLAC3D project has not been created in *2dldV6*.

Then, in FLAC3D, open and execute the script *initialize_model.f3grid* (the model is already configured for this example problem). A save file * tf_in.f3sav* is created once the mechanical steady state is calculated. This save file contains the grid, model parameters and steady state conditions that will be imported when running the coupled simulation.


.. _ex1-run-thm:

Run the coupled simulation
**************************

.. note::

    Beforehand, the user can optionally run a TOUGH3 (only) simulation to check whether the TOUGH3 input files are correctly edited (in subdirectory *2_TH*).

Once steady states have been conducted for both codes, the coupled simulation is ready to be performed. The coupled TOUGH-FLAC simulation for this example can be run from subdirectory *3_THM*. Before running the simulation, this subdirectory should contain the files:

* *2dldV6.dat*: TOUGH3 input file with blocks ``FLAC`` and ``GENER`` (and additional blocks for outputs). The run is conducted for 10 years,

    .. tip::

        Corresponding element label in ``MESH`` file for a specific point can be queried using the function :func:`toughflac.zone.near`. This can be useful to define the injection point or elements to save in the block ``FOFT``. In this input file, the label for the injection point can be found following:

        .. code-block:: python
        
            tf.zone.near((0.0, 0.0, -1480.0))

* *flac3d.py*: main TOUGH-FLAC (Python) script for the coupling,

* *tf_in.f3sav*: FLAC3D save file from steady state run,

* *MESH*: previously created in FLAC3D in Section :ref:`ex1-grids-generation`,

* *INCON*: *SAVE* file from steady state run renamed as *INCON*,

    .. tip::
    
        Last lines of the *SAVE* file must be deleted starting from line *+++*. The Bash script *run.sh* automates this task and assures the file to be correctly edited.

        .. code-block:: bash

            sed "/+++/Q" < ../1_TH_INI/SAVE > INCON
            echo "" >> INCON

* *CO2TAB*: required by equation-of-state ECO2N.


.. _ex1-set-permeability:

Define permeability models
^^^^^^^^^^^^^^^^^^^^^^^^^^

Permeability models can be defined directly in Python for rock groups with identifier 0 in the block ``FLAC``. In this example, porosity :math:`\phi` and permeability :math:`k` are related to mean effective stress :math:`\sigma'_M` following

.. math::
    \phi = \left( \phi_0 - \phi_r \right) \exp \left( 5 \cdot 10^{-8} \cdot \sigma'_M \right) + \phi_r

.. math::
    k = k_0 \exp \left( 22.2 \left( \frac{\phi}{\phi_0} -1 \right) \right)

where :math:`\phi_0`, :math:`\phi_r` and :math:`k_0` are respectively the stress-free and residual porosities, and stress-free permeability. This permeability model is already implemented and can be imported from :mod:`toughflac.coupling.permeability`:

.. code-block:: python

    from toughflac.coupling.permeability import rutqvist2002

To apply this permeability model to the desired rock groups (i.e. with identifier 0 in the block ``FLAC``), a dictionary ``permeability_func`` can be passed to the main coupling function :func:`run` which keys are the group labels and values are the permeability functions. Permeability functions can be individually defined for each rock group using anonymous ``lambda`` functions, the only input argument of these functions must be a boolean array (internally generated using :func:`itasca.zonearray.in_group`) while the group hydromechanical parameters are directly passed to the permeability model. In this example, the dictionary ``permeability_func`` is defined as follow:

.. code-block:: python

    permeability_func = {
        "UPPER": lambda g: rutqvist2002(g, k0=1.0e-15, phi0=0.1, phir=0.09),
        "CAPRO": lambda g: rutqvist2002(g, k0=1.0e-17, phi0=0.01, phir=0.009),
        "AQFER": lambda g: rutqvist2002(g, k0=1.0e-13, phi0=0.1, phir=0.09),
        "BASEM": lambda g: rutqvist2002(g, k0=1.0e-17, phi0=0.01, phir=0.009),
    }

Different permeability models can be associated to different rock groups. The user can also define custom permeability models that are not available in :mod:`toughflac.coupling.permeability` as long as it returns the permeability and porosity arrays for a given group (i.e. the size of the output arrays matches the number of elements that belong to the input group). Custom permeability models should basically be defined as follow:

.. code-block:: python

    from toughflac.coupling.permeability import permeability

    @permeability
    def my_permeability_model(group, k0, phi0, *args):
        # group is a boolean array returned by :func:`itasca.zonearray.in_group`
        # k0 is stress-free permeability
        # phi0 is stress-free porosity
        # Do something to calculate permeability k and porosity phi
        return k, phi

.. note::

    :func:`toughflac.coupling.permeability.permeability` is a function decorator that performs simple checks to verify that the defined function is a valid permeability model that can be used with TOUGH3-FLAC.


.. _ex1-set-history:

Define history variables
^^^^^^^^^^^^^^^^^^^^^^^^

History variables to save during the simulation can be defined using a dictionary with specific keywords to be passed to the function :func:`toughflac.coupling.run` in the main script *flac3d.py*. This dictionary (named ``history`` here) is hierarchized as follow:

.. code-block:: python

    history = {
        filename: {
            variable: coordinates,
        },
    }

where ``filename`` is the output history file name (format *csv*), ``variable`` is the name of a variable attribute available in :mod:`toughflac` (see Table :numref:`%s <toughflac-attributes>`) and ``coordinates`` is a list with the coordinates or ID of the points or zones where to query the variable parameter ``variable``. The dictionary ``history`` can contain more than one file, and each file can contain more than one variable. Array ``coordinates`` must always be 2D even though only one coordinate is needed.

In this example problem:

.. code-block:: python

    hist_variables = [
        "temp",
        "pp",
        "stress_prin_x",
        "stress_prin_y",
        "stress_prin_z",
        "stress_xx",
        "stress_yy",
        "stress_zz",
    ]
    history = {
        "hist1": {
            "disp_z": [
                [0.0, 0.0, 0.0],
                [0.0, 0.0, -1200.0],
                [0.0, 0.0, -1300.0],
                [0.0, 0.0, -1500.0],
            ],
        },
        "hist2": {k: [[0.0, 0.0, -1450.0]] for k in hist_variables},
        "hist3": {k: [[0.0, 0.0, -1290.0]] for k in hist_variables},
    }

will save in files:

1. *hist1.csv* the vertical displacement of gridpoints near ``[0.0, 0.0, 0.0]``, ``[0.0, 0.0, -1200.0]``, ``[0.0, 0.0, -1300.0]`` and ``[0.0, 0.0, -1500.0]``,
2. *hist2.csv* the temperature, pressure, principle stresses, and diagonal elements of the stress tensor for zone near ``[0.0, 0.0, -1450.0]``,
3. *hist3.csv* the temperature, pressure, principle stresses, and diagonal elements of the stress tensor for zone near ``[0.0, 0.0, -1290.0]``.


.. _ex1-run-simulation:

Run the simulation
^^^^^^^^^^^^^^^^^^

The user can also *customize* the TOUGH-FLAC simulation by specifying several coupling parameters among the FLAC3D save file to restore, the output directory the damping, the mechanical ratio, the number of threads, additional Python and/or FISH functions to execute after each mechanical analysis...

Once every files are set up, the coupled simulation can be conducted by executing the command ``tough3-eco2n 2dldV6.dat``.

.. tip::

    The user can execute the Bash script *run.sh* that will automatically import the required files before running the simulation.

Figure :numref:`%s <2dldV6-thm-run>` shows a screenshot of the two console windows when running a coupled TOUGH-FLAC simulation.

.. figure:: ../figures/2dldV6/thm_run.*
    :name: 2dldV6-thm-run
    :align: center

    Screenshot of coupled TOUGH-FLAC running at time step 20.


.. _ex1-outputs:

Outputs and results
*******************

This example problem should produce the FLAC3D save files *f1d.f3sav*, *f7d.f3sav*, *f30d.f3sav*, *f1y.f3sav*, *f3y.f3sav*, *f6s.f3sav* and *f10y.f3sav*. These are save files at 1 day, 1 week, 1 month, etc... as predefined in the block ``TIMES`` of the TOUGH3 input file. These files can be restored in FLAC3D for plotting of results or used to restart a TOUGH-FLAC simulation at any of these times.

Contour plots can be made from conventional TOUGH3 output file as well as from FLAC3D save files. Time-dependent TOUGH3 data can be plotted from *FOFT*. Figures :numref:`%s <2dldV6-pressure>` and :numref:`%s <2dldV6-displacement>` show the pressure and vertical displacement contour plots at the last time step.

.. figure:: ../figures/2dldV6/pressure.*
    :name: 2dldV6-pressure
    :align: center
    :width: 75%

    Contour plot of pressure at 10 years.

.. figure:: ../figures/2dldV6/displacement.*
    :name: 2dldV6-displacement
    :align: center
    :width: 75%

    Contour plot of vertical displacement at 10 years.

History variables can be plotted using the function :func:`toughflac.plot.history` that uses the :mod:`matplotlib` backend. This function provides many different options to customize history plots. For instance, the following code will produce Figure :numref:`%s <2dldV6-hist1>` using the style ``ggplot`` (sample script *Postprocessing/plot_history.py*).

.. code-block:: python

    import matplotlib.pyplot as plt
    plt.style.use("ggplot")

    tf.plot.history(
        filename="3_THM/f3out/hist1.csv",
        time_unit="year",
        ylabel="Vertical displacement (m)",
        plt_kws={
            "linewidth": [2, 2, 2, 2],
            "label": ["0 m", "-1200 m", "-1300 m", "-1500 m"],
        },
        legend_kws={
            "title": "Depth",
            "fontsize": 12,
            "loc": "lower center",
            "bbox_to_anchor": (0.5, 0.98),
            "ncol": 4,
            "frameon": False,
        },
    )

.. figure:: ../figures/2dldV6/hist1.*
    :name: 2dldV6-hist1
    :align: center
    :width: 90%

    Evolution of the vertical displacement plotted from *hist1.csv*.

.. tip::

    The function :func:`toughflac.plot.history` can also be used to plot the content of TOUGH *FOFT* files. For instance:

    .. code-block:: python

        tf.plot.history("3_THM/FOFT_A1793.csv", columns=1)

    will plot the evolution of the pressure at the injection point.


.. _example-2:

Upwelling of CO\ :sub:`2`-rich fluid along a vertical fault
-----------------------------------------------------------

This problem involves upwelling of CO\ :sub:`2`-rich fluid along a vertical fault. All the necessary input files can be found in a directory named *2DSEP5V6*. This directory contains the coupling Python script *flac3d.py* and five subdirectories:

* *1_TH_INI* to run a steady state calculation with TOUGH3 only,
* *2_TH* to test input files required for TOUGH3,
* *3_THM* to conduct a fully coupled TOUGH3 and FLAC3D v6 simulation,
* *Preprocessing* that contains scripts to generate TOUGH3 and FLAC3D grids (*generate_mesh.py* and *generate_mesh_gmsh.py*) and configure the mechanical model for FLAC3D (*initialize_model.f3grid*),
* *Postprocessing* that contains sample scripts to plot history variables and export results to a VTK file.

The three former subdirectories contain the TOUGH3 input file, a file *CO2TAB* needed for equation-of-state ECO2N, and two Bash scripts *clean.sh* and *run.sh*. These two scripts are not necessary and are only here for convenience (facilitate the workflow).

The user might want to start and save a new FLAC3D project in this directory (i.e. *2DSEP5V6*).

.. note::

    More advanced pre- and post-processing (e.g. import external meshes, export results to a VTK file) require the Python library :mod:`toughio` to be installed.


.. _ex2-grid-generation:

Grid generation for TOUGH3 and FLAC3D
*************************************

Although the grid files can be generated using the script *generate_mesh.py* in the same way as in the first example, this example will rather show how to import an external mesh file created by another software (here Gmsh, see Figure :numref:`%s <2DSEP5V6-gmsh>`).

In the following, we will selectively go through the content of the script *generate_mesh_gmsh.py* and only detail mesh import and processing.

.. figure:: ../figures/2DSEP5V6/gmsh.*
    :name: 2DSEP5V6-gmsh
    :align: center
    :width: 100%

    Mesh created in Gmsh. Physical groups (including boundary elements) have been defined in Gmsh.


The mesh file can be imported using the function :func:`toughio.read_mesh`:

.. code-block:: python

    mesh = toughio.read_mesh("gmsh/mesh.msh")

This creates a :class:`toughio.Mesh` object that contains the grid points coordinates, the cell connectivity (i.e. zones) and the data associated to these cells.

The input mesh is 2D and has been defined in the XY plane. Thus, grid points Y and Z coordinates must be swapped:

.. code-block:: python

    mesh.points[:, [1, 2]] = mesh.points[:, [2, 1]]
    
and a third dimension must be created along the Y axis using the method :meth:`toughio.Mesh.extrude_to_3d`:

.. code-block:: python

    mesh.extrude_to_3d(height=1.0, axis=1)

Finally, the processed mesh can be imported using the function :func:`toughflac.zone.import_mesh`:

.. code-block:: python

    tf.zone.import_mesh(mesh)

.. tip::

    A mesh file that does not require additional processing (e.g. already 3D) can be directly imported using the function :func:`toughflac.zone.import_`.

The FLAC3D grid should look like Figure :numref:`%s <2DSEP5V6-model-with-group>`.

.. figure:: ../figures/2DSEP5V6/model_with_group.*
    :name: 2DSEP5V6-model-with-group
    :align: center
    :width: 75%

    Gmsh grid imported into FLAC3D. Physical groups defined in Gmsh have been associated as zone groups.

For this example, initial conditions are defined for the top and the bottom of the model and pressure and temperature are fixed to constant values at the top of the grid:

.. code-block:: python

    tf.zone.set_dirichlet_bc("TOPBC")
    tf.zone.set_dirichlet_bc("TOPFC")

    tf.zone.initialize_pvariables(
        x1=lambda z: 1.5e5,
        x2=lambda z: 0.3e-2,
        x3=lambda z: 0.0,
        x4=lambda z: 8.0,
        group = ["TOPBC", "TOPFC"],
    )
    tf.zone.initialize_pvariables(
        x1=lambda z: 1.77e6,
        x2=lambda z: 0.3e-2,
        x3=lambda z: 0.0,
        x4=lambda z: 98.0,
        group = ["BOTBC", "BOTFC"],
    )

.. note::

    1. Initializing primary variables as constant values for specific groups is no different from setting ``INDOM`` block in TOUGH3 input file,
    2. Once the grid files are generated, the workflow is the same as in the first example.


.. _ex2-outputs:

Outputs and results
*******************

Contour plots of pressure and vertical displacement at the last time step are shown in Figures :numref:`%s <2DSEP5V6-pressure>` and :numref:`%s <2DSEP5V6-displacement>`. The history of the displacement for three different grid points is shown in Figure :numref:`%s <2DSEP5V6-hist1>` (sample script *Postprocessing/plot_history.py*).


.. figure:: ../figures/2DSEP5V6/pressure.*
    :name: 2DSEP5V6-pressure
    :align: center
    :width: 75%

    Contour plot of pressure at 4 years.


.. figure:: ../figures/2DSEP5V6/displacement.*
    :name: 2DSEP5V6-displacement
    :align: center
    :width: 75%

    Contour plot of vertical displacement at 4 years.


.. figure:: ../figures/2DSEP5V6/hist1.*
    :name: 2DSEP5V6-hist1
    :align: center
    :width: 90%

    Evolution of the displacement plotted from *hist1.csv*.


.. _ex2-export:

Export to VTK file
******************

The results for any FLAC3D save file can also be exported to a VTK file to be visualized with ParaView or :mod:`pyvista`, for instance, for advanced post-processing (sample script *Postprocessing/export_vtk.py*). The complete list of attribute variables to export can be found in Table :numref:`%s <toughflac-attributes>`.

.. figure:: ../figures/2DSEP5V6/displacement_pyvista.*
    :name: 2DSEP5V6-displacement-pyvista
    :align: center
    :width: 75%

    Contour plot of vertical displacement at 4 years (figure generated by :mod:`pyvista` using script *Postprocessing/plot_pyvista.py*).


.. _example-3:

Injection of CO\ :sub:`2` in an anisotropic reservoir rock
----------------------------------------------------------

This example describes a problem of CO\ :sub:`2` injection in a reservoir rock with high horizontal to vertical permeability ratio. All the necessary input files can be found in a directory named *CR2011*. This directory contains four subdirectories:

* *1_TH_INI* to run a steady state calculation,
* *2_TH* to conduct a TOUGH3 simulation,
* *Preprocessing* that contains scripts to generate TOUGH3 grid (*generate_mesh.py* and *generate_mesh_gmsh.py*),
* *Postprocessing* that contains a sample script to import and visualize TOUGH3 results in FLAC3D.

The two former subdirectories contain the TOUGH3 input file, a file *CO2TAB* needed for equation-of-state ECO2N, and two Bash scripts *clean.sh* and *run.sh*. These two scripts are not necessary and are only here for convenience (facilitate the workflow).

The user might want to start and save a new FLAC3D project in this directory (i.e. *CR2011*).

.. note::

    In this example, FLAC3D is only used as a pre- and post-processor to run a simple TOUGH3 simulation.


.. _ex3-grid-generation:

Grid generation for TOUGH3
**************************

.. figure:: ../figures/CR2011/model_with_group.*
    :name: CR2011-model-with-group
    :align: center
    :width: 100%

    Gmsh grid imported into FLAC3D.

In this example, we will generate the mesh using Gmsh again (script *generate_mesh_gmsh.py*). Grid import and processing, initial and boundary conditions settings are the same as in the previous example (see Section :ref:`example-2`). Only new arguments in function :func:`toughflac.zone.export_tough` will be described.

.. code-block:: python

    tf.zone.export_tough(
        "MESH",
        permeability=lambda zone: [1.0e-13, 1.0e-13, 1.0e-15] if zone.group() == "CENAQ" else [-1.0, -1.0, -1.0],
        group_end="BOUND",
        incon=True,
    )

In TOUGH3, isotropic and/or anisotropic permeability modifiers can be defined for each element of the mesh in either block ``ELEME`` (columns ``81-110``) or block ``INCON`` (columns ``31-60``). Individual permeability (and/or porosity) values can be exported by providing argument ``permeability`` (and/or ``porosity``) as a function of :class:`itasca.Zone`. In this example, vertical permeability of reservoir rock ``CENAQ`` is 100 times lower than its horizontal permeability (``[1.0e-13, 1.0e-13, 1.0e-15]``). The permeability in the other rocks is isotropic and set to ``[-1.0, -1.0, -1.0]`` since negative permeability modifiers are treated as multipliers in TOUGH3.

.. note::

    * In the current implementation, permeability modifiers are exported in columns ``31-60`` of block ``INCON`` so that custom porosity and permeability values for individual elements are at the same location.

    * For this simple example, providing argument ``permeability`` is not necessary as permeability is homogeneous for each rock which could be done simply by providing anisotropic permeability values in TOUGH3 input data. Nevertheless, providing arguments ``permeability`` (and/or ``porosity``) to function :func:`toughflac.zone.export_tough` can be used, for instance, to interpolate permeability logs to the model (and/or porosity logs).

Providing argument ``group_end="BOUND"`` moves all the elements in group ``BOUND`` to the bottom of block ``ELEME`` which can be useful if boundary elements are defined in a single rock type (and must be ignored by FLAC3D when running a coupled simulation).


.. _ex3-input:

TOUGH3 input
************

Although there is not much difference with the previous examples, the user still has to enable some options in TOUGH3 to correctly process anisotropic permeability values.

Since permeability modifiers are written in block ``INCON`` rather than ``ELEME``, ``MOP(13)`` in block ``PARAM`` must be set to ``1`` in order to write these custom values in `SAVE` file after running a steady state calculation.

In addition, ``MOP2(19)`` in block ``MOMOP`` must be set to a non-zero value which generalizes how TOUGH3 handles anisotropic permeability values to any type of mesh (i.e. not only hexahedral meshes).

.. note::

    Currently, this option is not available in base TOUGH3 and has only been implemented in TOUGH3-FLAC.


.. _ex3-outputs:

Outputs and results
*******************

TOUGH3 output files (`SAVE` and `OUTPUT_ELEME.csv`) can be imported into FLAC3D using functions :func:`toughflac.zone.import_tough_save` and :func:`toughflac.zone.import_tough_output`, respectively (see sample script *Postprocessing/import_tough.py*).

Contour plots of gas saturation at the last time step are shown in Figures :numref:`%s <CR2011-triangle-no-anisotropy>` and :numref:`%s <CR2011-triangle-no-anisotropy>` which shows the difference of CO\ :sub:`2` plume when ``MOP2(19) = 0`` and ``MOP2(19) = 1``. Figure :numref:`%s <CR2011-quad-anisotropy>` is displayed to allow comparison as a reference figure (i.e. expected result).


.. figure:: ../figures/CR2011/triangle_no_anisotropy.*
    :name: CR2011-triangle-no-anisotropy
    :align: center
    :width: 75%

    Contour plot of gas saturation with triangular mesh (``MOP2(19) = 0``).


.. figure:: ../figures/CR2011/triangle_anisotropy.*
    :name: CR2011-triangle-anisotropy
    :align: center
    :width: 75%

    Contour plot of gas saturation with triangular mesh (``MOP2(19) = 1``).


.. figure:: ../figures/CR2011/quad_anisotropy.*
    :name: CR2011-quad-anisotropy
    :align: center
    :width: 75%

    Contour plot of gas saturation with hexahedral mesh.
